<!DOCTYPE html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
            referrerpolicy="no-referrer" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/utilities.min.css"
            integrity="sha512-Y8cJYgNbd3VacNNezxAdncUu75Uj7uR/Dtb4ffepQrtFww5/QlgYt2IwexMwB8/SZWCCVe6kOY20A2Q4zQf5vQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer" />
            <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.4.1/dist/typography.min.css"></link>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"
            integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"
            integrity="sha512-oSA0PdOBsyP4Cv5rIHOWhOr+H0ZPOE/L8UKaX33DjBFD+TrWOZZfewjg85Z7WhNPkQrHeTKOYSio/XM6FBPhWA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
        <title>Network Looking Glass</title>
    </head>

    <body class="bg-pink-100">
        <main>
            <script>
        var node_url = window.location.href;
        var public_204 = 'https://cp.cloudflare.com'
       
      </script>
            <section class="py-8 px-8 lg:py-16">
                <div class="container gap-3 mx-auto">

                    <div class="grid gap-3 md:grid-cols-1 lg:grid-cols-2 ">
                        <div
                            class="h-full">
                            <div
                                class="col-span-1 rounded-xl bg-white border-4 border-gray-100 p-2 mb-3 md:col-span-2 flex justify-center items-center"
                                id="title">
                                <img
                                    src="https://static.homura.network/logo/logo.png"
                                    class="m-1 max-h-12 w-auto"
                                    alt="homuranetwork" width="150"
                                    height="150">
                                <h1 class="text-2xl m-1">Homura Network Looking
                                    Glass</h1>
                               
                            </div>
                            <div
                                class="col-span-1 rounded-xl bg-white border-4 border-gray-100 p-2 md:col-span-2 ">

                                <div class="py-2 px-4 mt-1 " id="intro"></div>
                            </div>
                        </div>
                        <div
                            class="rounded-xl bg-white border-4 border-gray-100 p-6">
                            <h2 class="text-2xl font-bold mb-6">Information</h2>
                            <div
                                class="grid grid-cols-1 md:grid-cols-10 gap-4 mb-6">
                                <div class="md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Your
                                        IPv4</label>
                                    <input
                                        id="VisitorIPv4"
                                        type="text"
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                        value
                                        readonly />
                                </div>
                                <div class="ipv6 md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Your
                                        IPv6</label>
                                    <input
                                        id="VisitorIPv6"
                                        type="text"
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                        value
                                        readonly />
                                </div>
                            </div>
                            <hr />
                            <div
                                class="grid grid-cols-1 md:grid-cols-10 gap-4 mb-6">
                                <div class="md:col-span-7">
                                    <label
                                        class="text-gray-600 font-medium">Datacenter</label>
                                    <select
                                        id="locationSelect"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="NONE">Select</option>
                                        <option
                                            value="https://HK-1.lg.homura.network">HK-1</option>
                                        <option
                                            value="https://HK-2.lg.homura.network">HK-2</option>
                                    </select>
                                </div>
                                <div class="md:col-span-3">
                                    <label
                                        class="text-gray-600 font-medium">TOOLS</label>
                                    <input
                                        id="Tools"
                                        type="text"
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                        value="WIP"
                                        readonly />
                                </div>
                                <div class="md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Test
                                        IPv4</label>
                                    <input
                                        id="ipv4Addr"
                                        type="text"
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                        value
                                        readonly />
                                </div>
                                <div class="md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Test
                                        Files(ipv4)</label>
                                    <div
                                        class="inline-flex rounded-md shadow-sm w-full mt-1"
                                        role="group">
                                        <a
                                            type="button"
                                            id="ipv4-100MB"
                                            class="text-center w-1/2 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                            100MB
                                        </a>
                                        <a
                                            type="button"
                                            id="ipv4-1000MB"
                                            class="text-center w-1/2 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                            1000MB
                                        </a>
                                    </div>
                                </div>
                                <div class="ipv6 md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Test
                                        IPv6</label>
                                    <input
                                        id="ipv6Addr"
                                        type="text"
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                        value
                                        readonly />
                                </div>

                                <div class="ipv6 md:col-span-5">
                                    <label
                                        class="text-gray-600 font-medium">Test
                                        Files(ipv6)</label>
                                    <div
                                        class="inline-flex rounded-md shadow-sm w-full mt-1"
                                        role="group">
                                        <a
                                            type="button"
                                            id="ipv6-100MB"
                                            class="text-center w-1/2 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                            100MB
                                        </a>
                                        <a
                                            type="button"
                                            id="ipv6-1000MB"
                                            class="text-center w-1/2 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                            1000MB
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div
                            class="flex-col rounded-xl border-4 border-gray-100 bg-white">
                            <div class="p-6">
                                <h2
                                    class="text-xl font-semibold mb-4">Tools</h2>
                                <div>
                                    <label
                                        for="target"
                                        class="sr-only block text-sm font-medium leading-6 text-gray-900">IP/Domain:</label>
                                    <div
                                        class="relative mt-2 rounded-md shadow-sm">
                                        <input
                                            type="text"
                                            required
                                            name="target"
                                            id="target"
                                            class="block w-full rounded-md border-0 py-1.5 pl-7 pr-20 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                                            placeholder="Enter IP or Domain" />
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center">
                                            <label for="ipversion"
                                                class="sr-only">IP
                                                Version</label>
                                            <select
                                                id="ipversion"
                                                name="ipversion"
                                                class="h-full rounded-md border-0 bg-transparent py-0 pl-2 pr-7 text-gray-500 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm">
                                                <option value="ipv4"
                                                    selected>IPv4</option>
                                                <option class="ipv6"
                                                    value="ipv6">IPv6</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div
                                    class="inline-flex rounded-md shadow-sm w-full mt-3"
                                    role="group">
                                    <button
                                        type="button"
                                        onclick="sendCommand('ping')"
                                        class="w-1/4 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                        Ping
                                    </button>
                                    <button
                                        type="button"
                                        onclick="sendCommand('mtr')"
                                        class="w-1/4 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                        MTR
                                    </button>
                                    <button
                                        type="button"
                                        onclick="sendCommand('traceroute')"
                                        class="w-1/4 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                        Traceroute
                                    </button>
                                    <button
                                        type="button"
                                        onclick="sendCommand('nexttrace')"
                                        class="w-1/4 px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-blue-500 dark:focus:text-white">
                                        Nexttrace
                                    </button>
                                </div>

                                <h3
                                    class="mt-6 sr-only text-gray-700">Output:</h3>
                                <pre
                                    id="output"
                                    class="font-mono text-xs whitespace-pre-wrap overflow-y-scroll h-80 max-h-80 bg-black text-green-400 p-4 border border-green-400 mt-2 p-2 rounded-lg">
...</pre>
                            </div>
                        </div>

                        <div
                            class="flex-col rounded-xl bg-white border-4 border-gray-100 bg-white p-6">
                            <div
                                class="flex justify-between items-center pb-4 mt-4 sm:px-4 sm:mt-0">
                                <h2
                                    class="text-xl font-semibold mb-4 inline-flex items-center">RTT
                                    Test</h2>
                                <div>
                                    <button id="startTest"
                                        class="text-white bg-blue-700  hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 ">
                                        Start Test
                                    </button>
                                    <button id="stopTest"
                                        class="text-red-600 inline-flex  items-center hover:text-white border border-red-600 hover:bg-red-600 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:border-red-500 dark:text-red-500 dark:hover:text-white dark:hover:bg-red-600 dark:focus:ring-red-900 disabled">
                                        Stop Test
                                    </button>
                                </div>
                            </div>
                            <canvas id="rttChart"
                                class="mt-4 max-h-80"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <script>
      var ws = null
      function scrollToBottom() {
        var output = document.getElementById('output');
        output.scrollTop = output.scrollHeight;
      }
      function openWebSocket() {
        if (ws !== null) {
          ws.close(1000, 'Closing connection normally')
        }
        ws = new WebSocket(node_url.replace(/^http(s)?:\/\//, 'ws$1://').replace(/\/$/, '') + '/lg_backend');

        ws.onmessage = function (event) {
          var output = document.getElementById('output')
          output.textContent += event.data + '\n'
          scrollToBottom();
        }
        ws.onclose = function (event) {
          if (!event.wasClean) {
            console.error('WebSocket closed unexpectedly')
          }
        }

        ws.onerror = function (error) {
          console.error('WebSocket error:', error);
        }
      }

      function sendCommand(commandType) {
        var target = document.getElementById('target').value;
        var ipversion = document.getElementById('ipversion').value;

        if (target == '') {
          document.getElementById('output').textContent =
            'Please enter IP or Domain'
          return;
        }

        var count = 5
        document.getElementById('output').textContent = '';
        openWebSocket();

        var cmd = {
          type: commandType,
          ipver: ipversion,
          target: target,
          count: parseInt(count)
        }

        ws.onopen = function () {
          ws.send(JSON.stringify(cmd))
        }
      }
    </script>
        <script>


let lg = {};

async function updatePageInfo() {
  try {
    lg = {};

    let response = await fetch(node_url + '/info', { redirect: 'follow' });
    let data = await response.json();
    lg = data;
   
    if (lg.IPv4Addr && lg.IPv4Addr !== "") {
        lg.IPv4URL = lg.IPv4URL.endsWith('/') ? lg.IPv4URL.slice(0, -1) : lg.IPv4URL;
   
      response = await fetch(lg.IPv4URL + '/info', { redirect: 'follow' });
      data = await response.json();
      lg.VisitorIPv4 = data.VisitorIP;
      lg.IPv4_100MB = data.IPv4URL + data['100M'];
      lg.IPv4_1000MB = data.IPv4URL + data['1000M'];
    }
    if (lg.IPv6Addr && lg.IPv6Addr !== "") {
        lg.IPv6URL = lg.IPv6URL.endsWith('/') ? lg.IPv6URL.slice(0, -1) : lg.IPv6URL;

        response = await fetch(lg.IPv6URL + '/info', { redirect: 'follow' })
            .catch(error => {
                console.error('Fetch error:', error);
                lg.VisitorIPv6 = "None";
                lg.IPv6_100MB = "";
                lg.IPv6_1000MB = "";
            });

        if (response) {
            data = await response.json();
            lg.VisitorIPv6 = data.VisitorIP;
            lg.IPv6_100MB = data.IPv6URL + data['100M'];
            lg.IPv6_1000MB = data.IPv6URL + data['1000M'];
        }
    }

    lg.hasIPv4 = lg.VisitorIPv4 && lg.VisitorIPv4 !== "";
    lg.hasIPv6 = lg.VisitorIPv6 && lg.VisitorIPv6 !== "" && lg.VisitorIPv6 !="None";


    if(lg.hasIPv4) {
      document.getElementById('VisitorIPv4').value = lg.VisitorIPv4;
      document.getElementById('ipv4Addr').value = lg.IPv4Addr;
      document.getElementById('ipv4-100MB').href = lg.IPv4_100MB;
      document.getElementById('ipv4-1000MB').href = lg.IPv4_1000MB;
    }

    if(lg.IPv6Addr && lg.IPv6Addr !== ""){
        document.querySelectorAll('.ipv6').forEach(el => {
            el.classList.remove('hidden');
        });
        document.getElementById('VisitorIPv6').value = lg.VisitorIPv6;
        document.getElementById('ipv6Addr').value = lg.IPv6Addr;
        document.getElementById('ipv6-100MB').href = lg.IPv6_100MB;
        document.getElementById('ipv6-1000MB').href = lg.IPv6_1000MB;
        
    }
    else {
        document.querySelectorAll('.ipv6').forEach(el => {
            el.classList.add('hidden');
        });
    }

    response = await fetch(node_url + '/intro', { redirect: 'follow' });
    lg.intro = await response.text();

    document.getElementById('intro').innerHTML = marked.parse(lg.intro);
  } catch (error) {
    console.error('Error:', error);
  }
}

</script>
        <script>


let testResultsIPv4 = [];
let testResultsIPv6 = [];
let testResultsPublic = []; 
let testInterval;
const maxTests = 20;
let stopRequested = false;
let chart = null;

document.getElementById('startTest').addEventListener('click', startTest);
document.getElementById('stopTest').addEventListener('click', stopTest);
setupChart();


function startTest() {
    resetChart();
    testResultsIPv4 = [];
    testResultsIPv6 = [];
    testResultsPublic = []; 
    stopRequested = false;
    this.disabled = true;
    document.getElementById('stopTest').disabled = false;
    testInterval = setInterval(runRttTest, 1000);

}


      function stopTest() {
        stopRequested = true;
        document.getElementById('stopTest').disabled = true;
        document.getElementById('startTest').disabled = false;
      }

      async function runRttTest() {
    
    await testRTT(public_204, testResultsPublic, 'Public Endpoint');

    if (stopRequested) { 
        return; 
    }
    if (lg.hasIPv4) {
        await testRTT(lg.IPv4URL + '/generate_204', testResultsIPv4, 'IPv4');
    }
    if (lg.hasIPv6) {
        await testRTT(lg.IPv6URL + '/generate_204', testResultsIPv6, 'IPv6');
    }

    if (stopRequested || testResultsIPv4.length >= maxTests || testResultsIPv6.length >= maxTests || testResultsPublic.length >= maxTests) {
        clearInterval(testInterval);
        document.getElementById('startTest').disabled = false;
    }
}

async function testRTT(url, resultsArray, label) {
    if (stopRequested) {
        return;
    }
    const startTime = performance.now();
    await fetch(url, { mode: 'no-cors' });
    const endTime = performance.now();
    const rtt = endTime - startTime;
    resultsArray.push(rtt);
    updateChart(resultsArray, label);
}

function setupChart() {
    const ctx = document.getElementById('rttChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: maxTests}, (_, i) => i + 1),
            datasets: []
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

      function updateChart(resultsArray, label) {
    let dataset = chart.data.datasets.find(dataset => dataset.label === label + ' RTT (ms)');
    if (!dataset) {
        dataset = {
            label: label + ' RTT (ms)',
            data: [],
            backgroundColor: label === 'IPv4' ? 'rgba(0, 123, 255, 0.5)' : label === 'IPv6' ? 'rgba(255, 99, 132, 0.5)' : 'rgba(75, 192, 192, 0.5)',
            borderColor: label === 'IPv4' ? 'rgba(0, 123, 255, 1)' : label === 'IPv6' ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        };
        chart.data.datasets.push(dataset);
    }
    dataset.data = resultsArray;
    chart.update();
}
function resetChart() {
    stopTest();
    chart.data.datasets= [];
    chart.update();
}


    </script>

        <script>
      const locationSelect = document.getElementById('locationSelect');

      locationSelect.addEventListener('change', function () {
        node_url = locationSelect.value;
        updatePageInfo();
        
        resetChart();

      })
      updatePageInfo();
    </script>
    </body>
</html>
